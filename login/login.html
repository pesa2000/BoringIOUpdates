
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Theme CSS -->
    <script>window.$ = window.jQuery = require('jquery');</script>
    <link rel="stylesheet" href="../assets/css/login.css" id="stylesheetLight">
    <link rel="stylesheet" href="../assets/css/login.css" id="stylesheetDark">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
      body {
        display: none;
      }

    </style>
    
    <!-- Title -->
    <title>Login</title>
  </head>
  <body class="d-flex align-items-center bg-auth border-top border-top-2" style=" -webkit-user-select: none; -webkit-app-region: drag;">

    <!-- CONTENT
    ================================================== -->
    <div class="container" style="-webkit-app-region: no-drag;">
      <div class="row justify-content-center">
        <div class="col-12 col-md-5 col-xl-4 my-5">
          
          <!-- Heading -->
          <h1 class="display-4 text-center mb-3">
            Sign in
          </h1>
          
          <!-- Subheading -->
          <p class="text-muted text-center mb-5">
            Automating Boring Stuff
          </p>
          
          <!-- Form -->
          <div>

            <!-- Email address -->
            <div class="form-group">

              <!-- Label -->
              <label>Username</label>

              <!-- Input -->
              <input type="text" class="form-control" placeholder="Enter your username" id="username">

            </div>

            <!-- Password -->
            <div class="form-group">

              <div class="row">
                <div class="col">
                      
                  <!-- Label -->
                  <label>Password</label>

                </div>
                <div class="col-auto">
                  
                  <!-- Help text -->
                  <a onclick='CreateWindow("https://www.boringio.com/login/ChangePasswordForm.php")' style="cursor: pointer;" target="_blank" class="form-text small text-muted">
                    Forgot password?
                  </a>

                </div>
              </div> <!-- / .row -->

              <!-- Input group -->
              <input type="password" id="password" class="form-control" placeholder="Enter your password">

            </div>

            <!-- Submit -->
            <button class="btn btn-lg btn-block btn-primary mb-3" id = "loginBtn" onclick="Login()">
              Sign in
            </button>

            <!-- Link -->
            <div class="text-center">
              <small class="text-muted text-center">
                Don't have an account yet? <a onclick="CreateWindow('https://www.boringio.com/login/register.php')" target="blank" style="color: #f1743b; cursor: pointer;">Sign up</a>.
              </small>
            </div>
            <div class="text-center" id="ErrorLabel" style="color: rgb(185, 40, 40); font-size: 20px;">
              
            </div>
            
          </div>

        </div>
      </div> <!-- / .row -->
    </div> <!-- / .container -->
    <script>
      const fs = require('fs')
      const ipc = require('electron').ipcRenderer
      const app = require("electron").remote.app
      var mysql = require('mysql')
      const path = require("path")
      const bcrypt = require('bcrypt')
      let $ = require('jquery')
      var AccountSavedDirectory = path.join(app.getPath("userData"),"/AccountSaved.txt")
      var UsernameSaved
      var PasswordSaved
      var BETA_MODE = true
      var pool = require("electron").remote.getGlobal('pool')
  
      function Minimize(){
          ipc.send("Minimize","login")
      }
  
      function Maximize(){
          ipc.send("Maximize","login")
      }
  
      function Close(){
          ipc.send("Close","login")
      }
  
      function CreateWindow(Type){
        console.log(Type)
        ipc.send("CreateWindow",Type)
      }
  
      async function Login(){
        var Username = document.getElementById('username').value
        var Password = document.getElementById('password').value
        pool.getConnection(function(err,connection){
          connection.query('SELECT * FROM utenti WHERE Username like ?', Username, async function (error, results, fields) {
          if (error) throw error;
              console.log(results)
              if(results.length == 1){
                  var PasswordHashed = results[0].Password
                  PassTemp = PasswordHashed
                  PasswordHashed = PasswordHashed.replace(/^\$2y(.+)$/i, '$2a$1')
                  bcrypt.compare(Password, PasswordHashed, async function(err, res) {
                      if(res == true){
                        console.log("Password Uguali")
                            if(BETA_MODE == true){
                              ipc.invoke('setUserId', results[0].UserId)
                              ipc.invoke('setAttachedInventory',results[0].AccountAttached)
                              ipc.invoke('setUsername', results[0].Username)
                              ipc.invoke('setEmail', results[0].Email)
                              ipc.invoke('setRenew', results[0].TypeSubscription)
                              ipc.invoke('setRenewDays', results[0].NextDate)
                              ipc.invoke('setImg', results[0].Immagine)
                              ipc.invoke('setValuta', results[0].Valuta)
                              fs.writeFile(AccountSavedDirectory, Username+":"+results[0].Password, function (err) {
                              if (err) throw err;
                                  console.log('Saved!');
                              });
                              ipc.send('entry-accepted', 'start')
                            }else{
                              ipc.send("CheckStripe",results)
                              ipc.on("ReturnedStripeLogin",(event,arg)=>{
                                if(arg){
                                  ipc.invoke('setUserId', results[0].UserId)
                                  ipc.invoke('setAttachedInventory',results[0].AccountAttached)
                                  ipc.invoke('setUsername', results[0].Username)
                                  ipc.invoke('setEmail', results[0].Email)
                                  ipc.invoke('setRenew', results[0].TypeSubscription)
                                  ipc.invoke('setRenewDays', results[0].NextDate)
                                  ipc.invoke('setImg', results[0].Immagine)
                                  ipc.invoke('setValuta', results[0].Valuta)
                                  fs.writeFile(AccountSavedDirectory, Username+":"+results[0].Password, function (err) {
                                  if (err) throw err;
                                      console.log('Saved!');
                                  });
                                  ipc.send('entry-accepted', 'start')
                                }else{
                                  console.log("Non hai pagato")
                                }
                              })
                            }
                            /*if(arg){
    
                            }else{
                              console.log("NON HAI PAGATO")
                            }*/
                      }else{
                          document.getElementById('ErrorLabel').innerText = "       Wrong username or password"
                      }
                  });
              }else{
                  document.getElementById('ErrorLabel').innerText = "      Wrong username or password"
              }
          });
        })
      }
      </script>

    <!-- JAVASCRIPT
    ================================================== -->
    <!-- Libs JS -->
    <script>if (typeof module === 'object') 
      {window.module = module; 
      module = undefined;}</script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script>if(window.module){module = window.module;}</script>
  </body>
</html>