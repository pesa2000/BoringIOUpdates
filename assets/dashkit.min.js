"use strict";

const { resolve } = require("path");

!(async function () {
    var e = document.getElementById("audienceChart");
    "undefined" != typeof Chart &&
        e &&
        new Chart(e, {
            type: "line",
            options: {
                scales: {
                    yAxes: [
                        {
                            id: "yAxisOne",
                            type: "linear",
                            display: "auto",
                            gridLines: { color: "#283E59", zeroLineColor: "#283E59" },
                            ticks: {
                                callback: function (e) {
                                    return e + "k";
                                },
                            },
                        },
                        {
                            id: "yAxisTwo",
                            type: "linear",
                            display: "auto",
                            gridLines: { color: "#283E59", zeroLineColor: "#283E59" },
                            ticks: {
                                callback: function (e) {
                                    return e + "%";
                                },
                            },
                        },
                    ],
                },
            },
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                datasets: [
                    { label: "Customers", data: [0, 10, 5, 15, 10, 20, 15, 25, 20, 30, 25, 40], yAxisID: "yAxisOne" },
                    { label: "Sessions", data: [50, 75, 35, 25, 55, 87, 67, 53, 25, 80, 87, 45], yAxisID: "yAxisOne", hidden: !0 },
                    { label: "Conversion", data: [40, 57, 25, 50, 57, 32, 46, 28, 59, 34, 52, 48], yAxisID: "yAxisTwo", hidden: !0 },
                ],
            },
        });
})(),
    (function () {
        var e = document.getElementById("conversionsChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "bar",
                options: {
                    scales: {
                        yAxes: [
                            {
                                ticks: {
                                    callback: function (e) {
                                        return e + "$";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    datasets: [
                        { label: "2020", data: [2500, 2430, 3340, 2342, 1347, 1343, 1348, 2336, 2248, 2246, 2240, 3224], backgroundColor: "#f1743f" },
                        { label: "2019", data: [2300, 2330, 5340, 6342, 1247, 1443, 1648, 2336, 2248, 2246, 2240, 3224], backgroundColor: "#fff", hidden: !0 },
                    ],
                },
            });
    })(),
    (async function () {
        var ObjReturned = await TakeData()
        console.log("Ritornato")
        console.log(ObjReturned)
        var e = document.getElementById("trafficChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "doughnut",
                options: {
                    tooltips: {
                        callbacks: {
                            afterLabel: function () {
                                return "%";
                            },
                        },
                    },
                },
                data: {
                    labels: ["Ships", "Proxies", "Bot", "Cookgroups", "Other"],
                    datasets: [
                        { data: [ObjReturned.p1, ObjReturned.p3, ObjReturned.p2, ObjReturned.p4, ObjReturned.p5], backgroundColor: ["#f17d4b", "#5f76e8", "#ff4f70", "#01caf1", "#41d366"] }
                        
                    ],
                },
            });
    })(),
    (function () {
        var e = document.getElementById("trafficChartAlt");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "doughnut",
                options: {
                    tooltips: {
                        callbacks: {
                            afterLabel: function () {
                                return "%";
                            },
                        },
                    },
                },
                data: {
                    labels: ["Direct", "Organic", "Referral"],
                    datasets: [
                        { data: [60, 25, 15], backgroundColor: ["#2C7BE5", "#A6C5F7", "#D2DDEC"] },
                        { data: [15, 45, 20], backgroundColor: ["#2C7BE5", "#A6C5F7", "#D2DDEC"], hidden: !0 },
                    ],
                },
            });
    })(),
    (function () {
        var e = document.getElementById("salesChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "line",
                options: {
                    scales: {
                        yAxes: [
                            {
                                ticks: {
                                    callback: function (e) {
                                        return "$" + e + "k";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: {
                    labels: ["Oct 1", "Oct 3", "Oct 6", "Oct 9", "Oct 12", "Oct 5", "Oct 18", "Oct 21", "Oct 24", "Oct 27", "Oct 30"],
                    datasets: [
                        { label: "All", data: [0, 10, 5, 15, 10, 20, 15, 25, 20, 30, 25] },
                        { label: "Direct", data: [7, 40, 12, 27, 34, 17, 19, 30, 28, 32, 24], hidden: !0 },
                        { label: "Organic", data: [2, 12, 35, 25, 36, 25, 34, 16, 4, 14, 15], hidden: !0 },
                    ],
                },
            });
    })(),
    (function () {
        var e = document.getElementById("ordersChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "bar",
                options: {
                    scales: {
                        yAxes: [
                            {
                                ticks: {
                                    callback: function (e) {
                                        return "$" + e + "k";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    datasets: [
                        { label: "Sales", data: [25, 20, 30, 22, 17, 10, 18, 26, 28, 26, 20, 32] },
                        { label: "Affiliate", data: [15, 10, 20, 12, 7, 0, 8, 16, 18, 16, 10, 22], backgroundColor: "#d2ddec", hidden: !0 },
                    ],
                },
            });
    })(),
    (function () {
        var e = document.getElementById("earningsChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "bar",
                options: {
                    scales: {
                        yAxes: [
                            {
                                id: "yAxisOne",
                                type: "linear",
                                display: "auto",
                                ticks: {
                                    callback: function (e) {
                                        return "$" + e + "k";
                                    },
                                },
                            },
                            {
                                id: "yAxisTwo",
                                type: "linear",
                                display: "auto",
                                ticks: {
                                    callback: function (e) {
                                        return e + "k";
                                    },
                                },
                            },
                            {
                                id: "yAxisThree",
                                type: "linear",
                                display: "auto",
                                ticks: {
                                    callback: function (e) {
                                        return e + "%";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun"],
                    datasets: [
                        { label: "Earnings", data: [18, 10, 5, 15, 10, 20, 15, 25, 20, 26, 25, 29, 18, 10, 5, 15, 10, 20], yAxisID: "yAxisOne" },
                        { label: "Sessions", data: [50, 75, 35, 25, 55, 87, 67, 53, 25, 80, 87, 45, 50, 75, 35, 25, 55, 19], yAxisID: "yAxisTwo", hidden: !0 },
                        { label: "Bounce", data: [40, 57, 25, 50, 57, 32, 46, 28, 59, 34, 52, 48, 40, 57, 25, 50, 57, 29], yAxisID: "yAxisThree", hidden: !0 },
                    ],
                },
            });
    })(),
    (function () {
        var e = document.getElementById("weeklyHoursChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "bar",
                options: {
                    scales: {
                        yAxes: [
                            {
                                ticks: {
                                    callback: function (e) {
                                        return e + "hrs";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: { labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"], datasets: [{ data: [21, 12, 28, 15, 5, 12, 17, 2] }] },
            });
    })(),
    (function () {
        var e = document.getElementById("overviewChart");
        e &&
            new Chart(e, {
                type: "line",
                options: {
                    scales: {
                        yAxes: [
                            {
                                id: "yAxisOne",
                                type: "linear",
                                display: "auto",
                                ticks: {
                                    callback: function (e) {
                                        return "$" + e + "k";
                                    },
                                },
                            },
                            {
                                id: "yAxisTwo",
                                type: "linear",
                                display: "auto",
                                ticks: {
                                    callback: function (e) {
                                        return e + "hrs";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    datasets: [
                        { label: "Earned", data: [0, 10, 5, 15, 10, 20, 15, 25, 20, 30, 25, 40], yAxisID: "yAxisOne" },
                        { label: "Hours Worked", data: [7, 35, 12, 27, 34, 17, 19, 30, 28, 32, 24, 39], yAxisID: "yAxisTwo", hidden: !0 },
                    ],
                },
            });
    })(),
    (function () {
        var e = document.getElementById("sparklineChart");
        "undefined" != typeof Chart &&
            e &&
            new Chart(e, {
                type: "line",
                options: {
                    scales: { yAxes: [{ display: !1 }], xAxes: [{ display: !1 }] },
                    elements: { line: { borderWidth: 2 }, point: { hoverRadius: 0 } },
                    tooltips: {
                        custom: function () {
                            return !1;
                        },
                    },
                },
                data: { labels: new Array(12), datasets: [{ data: [0, 15, 10, 25, 30, 15, 40, 50, 80, 60, 55, 65],borderColor: "#f1743f"  }]},
            });
    })(),
    (function () {
        var e = document.querySelectorAll("#sparklineChartSocialOne, #sparklineChartSocialTwo, #sparklineChartSocialThree, #sparklineChartSocialFour");
        "undefined" != typeof Chart &&
            e &&
            [].forEach.call(e, function (e) {
                new Chart(e, {
                    type: "line",
                    options: {
                        scales: { yAxes: [{ display: !1 }], xAxes: [{ display: !1 }] },
                        elements: { line: { borderWidth: 2, borderColor: "#f1743f" }, point: { hoverRadius: 0 } },
                        tooltips: {
                            custom: function () {
                                return !1;
                            },
                        },
                    },
                    data: { labels: new Array(12), datasets: [{ data: [0, 15, 10, 25, 30, 15, 40, 50, 80, 60, 55, 65] }] },
                });
            });
    })(),
    (function () {
        var e = document.getElementById("feedChart");
        e &&
            new Chart(e, {
                type: "bar",
                options: {
                    scales: {
                        yAxes: [
                            {
                                ticks: {
                                    callback: function (e) {
                                        return "$" + e + "k";
                                    },
                                },
                            },
                        ],
                    },
                },
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    datasets: [
                        { label: "Sales", data: [25, 20, 30, 22, 17, 10, 18, 26, 28, 26, 20, 32] },
                        { label: "Affiliate", data: [15, 10, 20, 12, 7, 0, 8, 16, 18, 16, 10, 22], backgroundColor: "#d2ddec", hidden: !0 },
                    ],
                },
            });
    })();

function TakeData(){
    return new Promise(function(resolve,reject){
        const connection = require("electron").remote.getGlobal("conn");
        const path = require("path")
        const Util = require(path.join(__dirname,"/utilityScripts/query_graphs_expenses.js"))
        const moment = require("moment")
        var UserId = require('electron').remote.getGlobal('UserId')
    
        var CostsBotList = []
        var CostsCookGroupList = []
        var CostsProxiesList = []
        var CostsShipsList = []
        var CostsOthersList = []
    
        var Filter1
        var Select = document.getElementById("FilterDate")
    
        $(document).ready(() => {
            ipc.send("RequestedMonthFilter")
            ipc.on("ReturnedMonthFilter",(event,arg)=>{
                Filter1 = parseInt(arg)
                Request()
            })
        })
    
        function GetNewDateMonth(){
            var d = moment(new Date()).format("DD[/]MM[/]YYYY").split("/")
            //console.log(d[2])
            return d[1]
        }
    
        function GetNewDateYear(){
            var d = moment(new Date()).format("DD[/]MM[/]YYYY").split("/")
            //console.log(d[2])
            return d[2]
        }
    
        function Request(FilterDate){
            ipc.send("getUserId")
        }
    
        ipc.on("ReturnedId",async (event,arg) => {
            UserId = arg
            connection.query("SELECT * FROM costi WHERE IdUtente = ? AND YEAR(DataCosto) <= ?",[UserId,GetNewDateYear()],  function (error, results, fields) {
                if(error) console.log(error)
                SplitArrays(results)
                Util.SetTypes(results)
                var Res = ""
                if(Filter1 == "Year"){
                    Res = Util.YearExpenses(results)
                }else{
                    Res = Util.MonthExpenses(results,Filter1)
                }
                var Res = CreateGraph(Res)
                resolve(Res)
            })
        })
    })
}

async function SplitArrays(CostsList){
    var length1 = 0
    var length2 = 0
    var length3 = 0
    var length4 = 0
    var length5 = 0
    for(var Cost of CostsList){
    //console.log(Cost)
        switch(Cost.NomeSelezioneCosto){
            case "Bot":
            CostsBotList.push(Cost)
            length3 += 1
            break;
            case "CookGroup":
            CostsCookGroupList.push(Cost)
            length1 += 1
            break;
            case "Proxy":
            CostsProxiesList.push(Cost)
            length2 += 1
            break;
            case "Ship":
            CostsShipsList.push(Cost)
            length4 += 1
            break;
            default:
            CostsOthersList.push(Cost)
            length5 += 1
            break;
        }
    }
}
        

async function CreateGraph(Res){
    console.log(Res)
    var Tot = Res.TotalBots + Res.TotalCookGroups + Res.TotalShips + Res.TotalProxies + Res.TotalOthers

    console.log(Tot)

    var p2 = parseInt((Res.TotalBots/Tot) * 100) 
    var p4 = parseInt((Res.TotalCookGroups/Tot) * 100) 
    var p1 = parseInt((Res.TotalShips/Tot) * 100) 
    var p3 = parseInt((Res.TotalProxies/Tot) * 100) 
    var p5 = parseInt((Res.TotalOthers/Tot) * 100)  

    console.log("Ordine di lettura")
    console.log(p1)
    console.log(p2)
    console.log(p3)
    console.log(p4)
    console.log(p5)

    var Color = []
    var Values = []

    if(p1 != 0){Color.push("#61C822"); Values.push(['CookGroups', p4])}
    if(p2 != 0){Color.push("#5f76e8"); Values.push(['Bots', p2])}
    if(p3 != 0){Color.push("#ff4f70"); Values.push(['Proxies', p3])}
    if(p4 != 0){Color.push("#01caf1"); Values.push(['Ships', p1])}
    if(p5 != 0){Color.push("#e6b975"); Values.push(['Others', p5])}

    console.log(p1)
    console.log(p2)
    console.log(p3)
    console.log(p4)
    console.log(p5)
    $("#P1").text(Valuta + " " +Res.TotalShips)
    $("#P2").text(Valuta + " " +Res.TotalProxies)
    $("#P3").text(Valuta + " " +Res.TotalBots)
    $("#P4").text(Valuta + " " +Res.TotalCookGroups)
    $("#P5").text(Valuta + " " +Res.TotalOthers)
    var Obj = {p1:p1,p2:p2,p3:p3,p4:p4,p5:p5}
    return Obj
}
